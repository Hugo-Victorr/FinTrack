      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.AWS_EC2_HOST }}
          EC2_USER: ${{ secrets.AWS_EC2_USER }}
          EC2_KEY: ${{ secrets.AWS_EC2_SSH_KEY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_TAG: ${{ github.sha }}

        run: |
          mkdir -p ~/.ssh
          echo "${{ env.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/id_rsa ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            set -e

            echo "================================"
            echo "Deploying FinTrack applications..."
            echo "================================"
            
            # Criar diretório de deployment
            DEPLOY_DIR="$HOME/fintrack-deployment"
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR" || { echo "Failed to create deployment directory"; exit 1; }
            
            echo "? Working directory: $DEPLOY_DIR"
            
            # Download docker-compose file
            echo ""
            echo "Downloading docker-compose configuration..."
            
            COMPOSE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose-prod.yml"
            echo "URL: $COMPOSE_URL"
            
            # Tentar baixar com retry
            MAX_ATTEMPTS=3
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
              
              if wget -q --timeout=10 -O docker-compose.yml "$COMPOSE_URL"; then
                echo "? Download successful"
                break
              else
                WGET_EXIT=$?
                echo "? Download failed (exit code: $WGET_EXIT)"
                
                if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                  echo "Retrying in 5 seconds..."
                  sleep 5
                fi
              fi
              
              ATTEMPT=$((ATTEMPT + 1))
            done

            if [ ! -f docker-compose.yml ]; then
              echo ""
              echo "? Failed to download docker-compose.yml after $MAX_ATTEMPTS attempts"
              echo ""
              echo "Troubleshooting:"
              echo "1. Verify the file exists on GitHub"
              echo "2. Check network connectivity: curl -I $COMPOSE_URL"
              echo "3. Check GitHub token permissions"
              exit 1
            fi
            
            echo "? docker-compose.yml downloaded successfully"
            echo "File size: $(wc -c < docker-compose.yml) bytes"
            
            # Validar que o arquivo não está vazio
            if [ ! -s docker-compose.yml ]; then
              echo "? docker-compose.yml is empty!"
              exit 1
            fi
            
            echo ""
            echo "Logging in to Docker Hub..."
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin 2>/dev/null || {
              echo "? Docker login failed"
              exit 1
            }
            echo "? Docker login successful"
            
            echo ""
            echo "Pulling latest images..."
            if ! docker-compose pull; then
              echo "? Failed to pull images"
              docker logout 2>/dev/null || true
              exit 1
            fi
            echo "? Images pulled successfully"
            
            echo ""
            echo "Stopping old containers..."
            docker-compose down 2>/dev/null || true
            
            echo ""
            echo "Starting services..."
            if ! docker-compose up -d; then
              echo "? Failed to start services"
              docker logout 2>/dev/null || true
              exit 1
            fi
            echo "? Services started"

            # Cleanup
            echo ""
            echo "Cleaning up..."
            docker logout 2>/dev/null || true
            
            echo ""
            echo "================================"
            echo "? Deployment completed successfully!"
            echo "================================"
            echo ""
            echo "Services running:"
            docker-compose ps
            echo ""
            echo "Health check:"
            docker-compose ps --format "table {{.Service}}\t{{.Status}}"
          EOF
